

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>track_operator &mdash; REEM Robocup@HOME 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="REEM Robocup@HOME 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="../index.html">REEM Robocup@HOME 1.0 documentation</a></div>
        <div class="rel">
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for track_operator</h1><div class="highlight"><pre>
<span class="c">#! /usr/bin/env python</span>
<span class="c"># vim: expandtab ts=4 sw=4</span>
<span class="c">### FOLOW_OPERATOR.PY ###</span>

<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">smach</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">pal_smach_utils.utils.global_common</span> <span class="kn">import</span> <span class="n">succeeded</span><span class="p">,</span> <span class="n">preempted</span><span class="p">,</span> <span class="n">aborted</span><span class="p">,</span> <span class="n">transform_pose</span>
<span class="kn">from</span> <span class="nn">iri_perception_msgs.msg</span> <span class="kn">import</span> <span class="n">peopleTrackingArray</span><span class="p">,</span> <span class="n">peopleTracking</span>
<span class="kn">from</span> <span class="nn">pal_smach_utils.utils.topic_reader</span> <span class="kn">import</span> <span class="n">TopicReaderState</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">PoseStamped</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">,</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">tf.transformations</span> <span class="kn">import</span> <span class="n">quaternion_from_euler</span>
<span class="kn">from</span> <span class="nn">visualization_msgs.msg</span> <span class="kn">import</span> <span class="n">Marker</span>
<span class="kn">from</span> <span class="nn">pal_smach_utils.utils.math_utils</span> <span class="kn">import</span> <span class="n">vector_magnitude</span><span class="p">,</span> <span class="n">normalize_vector</span><span class="p">,</span> <span class="n">multiply_vector</span><span class="p">,</span> <span class="n">euclidean_distance</span><span class="p">,</span> <span class="n">euclidean_distance_3d</span>
<span class="kn">from</span> <span class="nn">pal_smach_utils.utils.publish_marker</span> <span class="kn">import</span> <span class="n">PublishGeneralMarker</span>

<span class="kn">from</span> <span class="nn">smach</span> <span class="kn">import</span> <span class="n">CBState</span>
<span class="kn">from</span> <span class="nn">pal_smach_utils.utils.colors</span> <span class="kn">import</span> <span class="n">Colors</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">Colors</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">pal_smach_utils.speech.sound_action</span> <span class="kn">import</span> <span class="n">SpeakActionState</span>

<span class="kn">from</span> <span class="nn">pal_smach_utils.utils.timeout_container</span> <span class="kn">import</span> <span class="n">SleepState</span>

<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Int32</span>

<span class="kn">from</span> <span class="nn">pr2_controllers_msgs.msg</span> <span class="kn">import</span> <span class="n">PointHeadGoal</span><span class="p">,</span> <span class="n">PointHeadAction</span>

<span class="kn">from</span> <span class="nn">actionlib</span> <span class="kn">import</span> <span class="n">SimpleActionClient</span>

<span class="kn">from</span> <span class="nn">pal_smach_utils.utils.debug</span> <span class="kn">import</span> <span class="n">debugPrint</span>

<span class="kn">from</span> <span class="nn">pal_smach_utils.utils.gesture_recognition</span> <span class="kn">import</span> <span class="n">GestureRecognition</span>
<span class="kn">from</span> <span class="nn">pal_smach_utils.navigation.move_to_caller</span> <span class="kn">import</span> <span class="n">MoveToCallerStateMachine</span>

<span class="kn">from</span> <span class="nn">smach_ros</span> <span class="kn">import</span> <span class="n">SimpleActionState</span>
<span class="kn">from</span> <span class="nn">rospy.rostime</span> <span class="kn">import</span> <span class="n">Duration</span>


<span class="n">MOVE_BASE_TOPIC_GOAL</span> <span class="o">=</span> <span class="s">&quot;/move_by/move_base_simple/goal&quot;</span>

<span class="n">GO_TO_LOC_TIMEOUT</span> <span class="o">=</span> <span class="mf">0.15</span>

<span class="c">#####################################################################</span>
<span class="c">#GoToLOcationMarker</span>
<span class="n">GO_LOC_MARKER_NAME</span> <span class="o">=</span> <span class="s">&quot;/track_operator/nav_goal&quot;</span>
<span class="n">GO_LOC_MARKER_TYPE</span> <span class="o">=</span> <span class="s">&quot;ARROW&quot;</span>
<span class="n">GO_LOC_MARKER_COLOUR</span> <span class="o">=</span> <span class="s">&quot;BLUE&quot;</span>
<span class="n">GO_LOC_MARKER_SCALE</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c">#####################################################################</span>

<span class="n">MAX_LEARN_DISTANCE</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s">&#39;/params_follow_me/max_distance&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="n">MAX_LEARN_DISPLACEMENT</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s">&#39;/params_follow_me/max_displace&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">MAX_STILL_VELOCITY</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s">&#39;/params_follow_me/max_still_velocity&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">MAX_LAST_POSITION_RADIUS</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">MAX_DISTANCE_RADIUS</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">MAX_DISTANCE_TO_ROBOT_RADIUS</span> <span class="o">=</span> <span class="mf">2.5</span>

<span class="n">TO_BE_REMOVED_MASK</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="n">OCCLUDDED_MASK</span> <span class="o">=</span> <span class="mh">0x02</span>
<span class="n">CANDIDATE_MASK</span> <span class="o">=</span> <span class="mh">0x04</span>
<span class="n">LEGGED_TARGET_MASK</span> <span class="o">=</span> <span class="mh">0x08</span>
<span class="n">VISUALLY_CONFIRMED_MASK</span> <span class="o">=</span> <span class="mh">0x10</span>
<span class="n">FRIEND_IN_SIGHT_MASK</span> <span class="o">=</span> <span class="mh">0x20</span>
<span class="n">BACK_LEARNT_MASK</span> <span class="o">=</span> <span class="mh">0x40</span>
<span class="n">FACE_LEARNT_MASK</span> <span class="o">=</span> <span class="mh">0x80</span>

<span class="n">pt_learning_zone_marker_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s">&quot;/LEARNING_ZONE_people_tracker_test/&quot;</span><span class="p">,</span> <span class="n">Marker</span><span class="p">)</span>
<span class="n">learning_zone_marker</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">()</span>

<span class="n">ELEVATOR_DISTANCE_TO_HUMAN</span> <span class="o">=</span> <span class="mf">0.65</span>

<span class="n">last_time_occluded</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">not_say_again</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">SECONDS_TO_BE_CONSIDERED_OCCLUDED</span> <span class="o">=</span> <span class="mf">30.0</span>

<span class="n">robot_head_heights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.9</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]</span>
<span class="n">robot_head_heights_index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">DETECT_FACE_TIMEOUT</span> <span class="o">=</span> <span class="mf">4.0</span>
<span class="n">head_client</span> <span class="o">=</span> <span class="n">SimpleActionClient</span><span class="p">(</span><span class="s">&quot;/head_traj_controller/point_head_action&quot;</span><span class="p">,</span> <span class="n">PointHeadAction</span><span class="p">)</span>

<span class="n">person_height</span> <span class="o">=</span> <span class="mf">1.3</span>

<span class="kn">from</span> <span class="nn">pal_vision_msgs.msg</span> <span class="kn">import</span> <span class="n">FaceDetection</span><span class="p">,</span> <span class="n">FaceDetections</span>


<span class="k">def</span> <span class="nf">isOccluded</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">peopleSet</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">targetStatus</span> <span class="o">&amp;</span> <span class="n">OCCLUDDED_MASK</span> <span class="o">==</span> <span class="n">OCCLUDDED_MASK</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#FIXME</span>
    <span class="sd">&#39;&#39;&#39;if (peopleSet is not None):</span>
<span class="sd">        person_pose = Pose()</span>
<span class="sd">        person_pose.position.x = person.x</span>
<span class="sd">        person_pose.position.y = person.y</span>
<span class="sd">        person_distance = vector_magnitude(person_pose.position)</span>
<span class="sd">        person_alfa = math.atan2(person_pose.position.y, person_pose.position.x)</span>
<span class="sd">        person_degrees = math.degrees(person_alfa)</span>
<span class="sd">        for pt_person in peopleSet:</span>
<span class="sd">            # the person being tracked cannot be occluded by himself!</span>
<span class="sd">            if (pt_person.targetId != person.targetId):</span>
<span class="sd">                pt_person_pose = Pose()</span>
<span class="sd">                pt_person_pose.position.x = pt_person.x</span>
<span class="sd">                pt_person_pose.position.y = pt_person.y</span>
<span class="sd">                pt_person_distance = vector_magnitude(pt_person_pose.position)</span>
<span class="sd">                pt_person_alfa = math.atan2(pt_person_pose.position.y, pt_person_pose.position.x)</span>
<span class="sd">                pt_person_degrees = math.degrees(pt_person_alfa)</span>
<span class="sd">                OCCLUSION_DISTANCE_OFFSET = 0.5</span>
<span class="sd">                OCCLUSION_DEGREES = 5.0</span>

<span class="sd">                if (pt_person_distance &lt; (person_distance - OCCLUSION_DISTANCE_OFFSET) and math.fabs(pt_person_degrees - person_degrees) &lt; OCCLUSION_DEGREES):</span>
<span class="sd">                    # the person is considered occluded</span>
<span class="sd">                    debugPrint(</span>
<span class="sd">                        colors.BACKGROUND_YELLOW +</span>
<span class="sd">                        &quot;The person being tracked was occluded by this other person: &quot; + str(pt_person) +</span>
<span class="sd">                        colors.NATIVE_COLOR, 0)</span>
<span class="sd">                    debugPrint(</span>
<span class="sd">                        colors.BACKGROUND_YELLOW +</span>
<span class="sd">                        &quot;The data that was considered an occlusion is: &quot; +</span>
<span class="sd">                        colors.NATIVE_COLOR, 0)</span>
<span class="sd">                    debugPrint(</span>
<span class="sd">                        colors.BACKGROUND_YELLOW +</span>
<span class="sd">                        &quot;    Distance of person tracked and person occluding: &quot; +</span>
<span class="sd">                        str(pt_person_distance) +</span>
<span class="sd">                        &quot; and &quot; +</span>
<span class="sd">                        str(person_distance) +</span>
<span class="sd">                        &quot; with an offset of &quot; +</span>
<span class="sd">                        str(OCCLUSION_DISTANCE_OFFSET) +</span>
<span class="sd">                        colors.NATIVE_COLOR, 0)</span>
<span class="sd">                    debugPrint(</span>
<span class="sd">                        colors.BACKGROUND_YELLOW +</span>
<span class="sd">                        &quot;    Degress between person tracked and person occluding: &quot; +</span>
<span class="sd">                        str(math.fabs(pt_person_degrees - person_degrees)) +</span>
<span class="sd">                        &quot; with a limit of degrees to consider occlusion of &quot; +</span>
<span class="sd">                        str(OCCLUSION_DEGREES) +</span>
<span class="sd">                        colors.NATIVE_COLOR, 0)</span>
<span class="sd">                    return True&#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">isLeggedTarget</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">targetStatus</span> <span class="o">&amp;</span> <span class="n">LEGGED_TARGET_MASK</span> <span class="o">==</span> <span class="n">LEGGED_TARGET_MASK</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">isVisuallyConfirmed</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">targetStatus</span> <span class="o">&amp;</span> <span class="n">VISUALLY_CONFIRMED_MASK</span> <span class="o">==</span> <span class="n">VISUALLY_CONFIRMED_MASK</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">isBackLearnt</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">targetStatus</span> <span class="o">&amp;</span> <span class="n">BACK_LEARNT_MASK</span> <span class="o">==</span> <span class="n">BACK_LEARNT_MASK</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">isFaceLearnt</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">targetStatus</span> <span class="o">&amp;</span> <span class="n">FACE_LEARNT_MASK</span> <span class="o">==</span> <span class="n">FACE_LEARNT_MASK</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">printPersonStatus</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
    <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_YELLOW</span> <span class="o">+</span> <span class="s">&quot;STATUS of the target id =&gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">targetStatus</span><span class="p">)</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isOccluded</span><span class="p">(</span><span class="n">person</span><span class="p">)):</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_BLUE</span> <span class="o">+</span> <span class="s">&quot;OCCLUDED TARGET&quot;</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isLeggedTarget</span><span class="p">(</span><span class="n">person</span><span class="p">)):</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s">&quot;LEGGED TARGET&quot;</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isVisuallyConfirmed</span><span class="p">(</span><span class="n">person</span><span class="p">)):</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_GREEN</span> <span class="o">+</span> <span class="s">&quot;VISUALLY CONFIRMED&quot;</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isBackLearnt</span><span class="p">(</span><span class="n">person</span><span class="p">)):</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">BLUE</span> <span class="o">+</span> <span class="s">&quot;BACK LEARNT&quot;</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isFaceLearnt</span><span class="p">(</span><span class="n">person</span><span class="p">)):</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_BLUE</span> <span class="o">+</span> <span class="s">&quot;FACE LEARNT&quot;</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>


<div class="viewcode-block" id="applyFilterOne"><a class="viewcode-back" href="../pkg_documentation/pal_smach_utils/pal_smach_utils_doc.html#track_operator.applyFilterOne">[docs]</a><span class="k">def</span> <span class="nf">applyFilterOne</span><span class="p">(</span><span class="n">tracked_person</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">peopleSet</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Tries to find the last person we were tracking. To do this we only have to</span>
<span class="sd">    look for the same target id.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">debugPrint</span><span class="p">(</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span>
        <span class="s">&#39;    APPLYING FILTER N. 1: Trying to find the last person tracked with the same id...&#39;</span> <span class="o">+</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tracked_person</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">peopleSet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>

        <span class="n">debugPrint</span><span class="p">(</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span>
            <span class="s">&quot;        data of the last person tracked</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">tracked_person</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">targetId</span> <span class="o">=</span> <span class="n">tracked_person</span><span class="o">.</span><span class="n">targetId</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">peopleSet</span><span class="p">:</span>
            <span class="n">debugPrint</span><span class="p">(</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span>
                <span class="s">&quot;        data of the person detected: </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">targetId</span> <span class="o">==</span> <span class="n">targetId</span><span class="p">):</span>
                <span class="n">debugPrint</span><span class="p">(</span>
                    <span class="n">colors</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span>
                    <span class="s">&#39;        [PASS] FILTER N. 1: The same target id was found in the new people set.&#39;</span> <span class="o">+</span>
                    <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">person</span>

    <span class="n">debugPrint</span><span class="p">(</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span>
        <span class="s">&#39;    [FAIL] FILTER N. 1 : unable to find the last person tracked.&#39;</span> <span class="o">+</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="applyFilterTwo"><a class="viewcode-back" href="../pkg_documentation/pal_smach_utils/pal_smach_utils_doc.html#track_operator.applyFilterTwo">[docs]</a><span class="k">def</span> <span class="nf">applyFilterTwo</span><span class="p">(</span><span class="n">tracked_person</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">peopleSet</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Tries to find a person within a circle of MAX_LAST_POSITION_RADIUS radius around the last position</span>
<span class="sd">    of the last tracked person.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">debugPrint</span><span class="p">(</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span>
        <span class="s">&#39;    APPLYING FILTER N. 2: Selecting a person only near the last tracked position...&#39;</span> <span class="o">+</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tracked_person</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">peopleSet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>

        <span class="n">debugPrint</span><span class="p">(</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span>
            <span class="s">&quot;        data of the last person tracked</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">tracked_person</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">nearest_person_inside_radius</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">min_distance</span> <span class="o">=</span> <span class="n">MAX_LAST_POSITION_RADIUS</span>
        <span class="n">old_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>
        <span class="n">old_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">tracked_person</span><span class="o">.</span><span class="n">x</span>
        <span class="n">old_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">tracked_person</span><span class="o">.</span><span class="n">y</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">peopleSet</span><span class="p">:</span>
            <span class="n">debugPrint</span><span class="p">(</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span>
                <span class="s">&quot;        data of the person detected: </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">person_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>
            <span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">x</span>
            <span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">y</span>
            <span class="n">distance_from_old_pose</span> <span class="o">=</span> <span class="n">euclidean_distance</span><span class="p">(</span><span class="n">person_pose</span><span class="p">,</span> <span class="n">old_pose</span><span class="p">)</span>
            <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="s">&quot;        distance from last position to person: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">distance_from_old_pose</span><span class="p">)</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">distance_from_old_pose</span> <span class="o">&lt;</span> <span class="n">min_distance</span><span class="p">):</span><span class="c"># &#39;&#39;&#39; and isVisuallyConfirmed(person)&#39;&#39;&#39; ):</span>
                <span class="n">min_distance</span> <span class="o">=</span> <span class="n">distance_from_old_pose</span>
                <span class="n">nearest_person_inside_radius</span> <span class="o">=</span> <span class="n">person</span>

        <span class="k">if</span> <span class="n">nearest_person_inside_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">debugPrint</span><span class="p">(</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span>
                <span class="s">&#39;        [PASS] FILTER N. 2: A candidate near the last tracked person was found.&#39;</span> <span class="o">+</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nearest_person_inside_radius</span>

    <span class="n">debugPrint</span><span class="p">(</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span>
        <span class="s">&#39;    [FAIL] FILTER N. 2 NOT passed: unable to find any candidate near the last tracked position.&#39;</span> <span class="o">+</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="applyFilterThree"><a class="viewcode-back" href="../pkg_documentation/pal_smach_utils/pal_smach_utils_doc.html#track_operator.applyFilterThree">[docs]</a><span class="k">def</span> <span class="nf">applyFilterThree</span><span class="p">(</span><span class="n">tracked_person</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">peopleSet</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Tries to find the nearest person to the last position</span>
<span class="sd">    of the last tracked person.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">debugPrint</span><span class="p">(</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span>
        <span class="s">&#39;    APPLYING FILTER N. 3: Selecting the nearest visually confirmed person to the last tracked position...&#39;</span> <span class="o">+</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tracked_person</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">peopleSet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>

        <span class="n">debugPrint</span><span class="p">(</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span>
            <span class="s">&quot;        data of the last person tracked</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">tracked_person</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">nearest_person</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">min_distance</span> <span class="o">=</span> <span class="n">MAX_DISTANCE_RADIUS</span>  <span class="c"># should be more than enough, since the distance is measured in meters</span>
        <span class="n">old_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>
        <span class="n">old_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">tracked_person</span><span class="o">.</span><span class="n">x</span>
        <span class="n">old_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">tracked_person</span><span class="o">.</span><span class="n">y</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">peopleSet</span><span class="p">:</span>
            <span class="n">debugPrint</span><span class="p">(</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span>
                <span class="s">&quot;        data of the person detected: </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">person_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>
            <span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">x</span>
            <span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">y</span>
            <span class="n">distance_from_old_pose</span> <span class="o">=</span> <span class="n">euclidean_distance</span><span class="p">(</span><span class="n">person_pose</span><span class="p">,</span> <span class="n">old_pose</span><span class="p">)</span>
            <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="s">&quot;        distance from last position to person: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">distance_from_old_pose</span><span class="p">)</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">distance_from_old_pose</span> <span class="o">&lt;</span> <span class="n">min_distance</span> <span class="ow">and</span> <span class="n">isVisuallyConfirmed</span><span class="p">(</span><span class="n">person</span><span class="p">)):</span>
                <span class="n">min_distance</span> <span class="o">=</span> <span class="n">distance_from_old_pose</span>
                <span class="n">nearest_person</span> <span class="o">=</span> <span class="n">person</span>

        <span class="k">if</span> <span class="n">nearest_person</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">debugPrint</span><span class="p">(</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span>
                <span class="s">&#39;        [PASS] FILTER N. 3: The nearest candidate to the last tracked person was found.&#39;</span> <span class="o">+</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nearest_person</span>

    <span class="n">debugPrint</span><span class="p">(</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span>
        <span class="s">&#39;    [FAIL] FILTER N. 3 NOT passed: unable to find any candidate.&#39;</span> <span class="o">+</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="applyFilterFour"><a class="viewcode-back" href="../pkg_documentation/pal_smach_utils/pal_smach_utils_doc.html#track_operator.applyFilterFour">[docs]</a><span class="k">def</span> <span class="nf">applyFilterFour</span><span class="p">(</span><span class="n">tracked_person</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">peopleSet</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Tries to find the nearest person to the robot.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">debugPrint</span><span class="p">(</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span>
        <span class="s">&#39;    APPLYING FILTER N. 4: Selecting the nearest visually confirmed person to the robot...&#39;</span> <span class="o">+</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tracked_person</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">peopleSet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>

        <span class="n">debugPrint</span><span class="p">(</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span>
            <span class="s">&quot;        data of the last person tracked</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">tracked_person</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">nearest_person</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">min_distance</span> <span class="o">=</span> <span class="n">MAX_DISTANCE_TO_ROBOT_RADIUS</span>
        <span class="n">robot_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>  <span class="c"># the robot position is the origin in the base_link frame</span>
        <span class="n">robot_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">robot_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">peopleSet</span><span class="p">:</span>
            <span class="n">debugPrint</span><span class="p">(</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span>
                <span class="s">&quot;        data of the person detected: </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">person_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>
            <span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">x</span>
            <span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">y</span>
            <span class="n">distance_from_robot</span> <span class="o">=</span> <span class="n">euclidean_distance</span><span class="p">(</span><span class="n">person_pose</span><span class="p">,</span> <span class="n">robot_pose</span><span class="p">)</span>
            <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="s">&quot;        distance from tobot to person: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">distance_from_robot</span><span class="p">)</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">distance_from_robot</span> <span class="o">&lt;</span> <span class="n">min_distance</span><span class="p">):</span> <span class="c">#&#39;&#39;&#39; and isVisuallyConfirmed(person)&#39;&#39;&#39; ):</span>
                <span class="n">min_distance</span> <span class="o">=</span> <span class="n">distance_from_robot</span>
                <span class="n">nearest_person</span> <span class="o">=</span> <span class="n">person</span>

        <span class="k">if</span> <span class="n">nearest_person</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">debugPrint</span><span class="p">(</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span>
                <span class="s">&#39;        [PASS] FILTER N. 4: The nearest candidate to the robot was found.&#39;</span> <span class="o">+</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nearest_person</span>

    <span class="n">debugPrint</span><span class="p">(</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span>
        <span class="s">&#39;    [FAIL] FILTER N. 4 NOT passed: unable to find any candidate.&#39;</span> <span class="o">+</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span>

</div>
<span class="k">class</span> <span class="nc">FilterAndProcessPeopleTrackerData</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">,</span> <span class="s">&#39;no_plausible_person_found&#39;</span><span class="p">,</span> <span class="s">&quot;tracked_person_is_occluded&quot;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in_persons_detected&#39;</span><span class="p">,</span> <span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">,</span> <span class="s">&quot;currentFilterTries&quot;</span><span class="p">,</span> <span class="s">&quot;currentUsedFilter&quot;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">,</span> <span class="s">&quot;currentFilterTries&quot;</span><span class="p">,</span> <span class="s">&quot;currentUsedFilter&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;### ENTERING &quot;FILTER_AND_PROCESS_PEOPLE_TRACKER_DATA&quot; STATE ###&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;    Number of persons detected </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_persons_detected</span><span class="o">.</span><span class="n">peopleSet</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">tracked_person</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">out_new_tracked_person</span>
        <span class="n">tries</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">currentFilterTries</span>
        <span class="n">usedFilter</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">currentUsedFilter</span>

        <span class="n">debugPrint</span><span class="p">(</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">YELLOW_BOLD</span> <span class="o">+</span>
            <span class="s">&#39;    APPLYING FILTERS...&#39;</span> <span class="o">+</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c"># FILTER 1</span>
        <span class="n">FILTER_TRIES</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">usedFilter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&lt;</span> <span class="n">FILTER_TRIES</span><span class="p">):</span>
                <span class="n">new_tracked_person</span> <span class="o">=</span> <span class="n">applyFilterOne</span><span class="p">(</span><span class="n">tracked_person</span><span class="p">,</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_persons_detected</span><span class="o">.</span><span class="n">peopleSet</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">new_tracked_person</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="n">userdata</span><span class="o">.</span><span class="n">out_new_tracked_person</span> <span class="o">=</span> <span class="n">new_tracked_person</span>
                    <span class="n">userdata</span><span class="o">.</span><span class="n">currentFilterTries</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">isOccluded</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">out_new_tracked_person</span><span class="p">,</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_persons_detected</span><span class="o">.</span><span class="n">peopleSet</span><span class="p">)):</span>
                        <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_BLUE</span> <span class="o">+</span> <span class="s">&quot;Movement and process cancelled till person is not occluded&quot;</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="k">return</span> <span class="s">&quot;tracked_person_is_occluded&quot;</span>
                    <span class="k">return</span> <span class="n">succeeded</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">currentFilterTries</span> <span class="o">=</span> <span class="n">tries</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">usedFilter</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">currentUsedFilter</span> <span class="o">=</span> <span class="n">usedFilter</span>

        <span class="c"># FILTER 2</span>
        <span class="n">FILTER_TRIES</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">usedFilter</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&lt;</span> <span class="n">FILTER_TRIES</span><span class="p">):</span>
                <span class="n">new_tracked_person</span> <span class="o">=</span> <span class="n">applyFilterTwo</span><span class="p">(</span><span class="n">tracked_person</span><span class="p">,</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_persons_detected</span><span class="o">.</span><span class="n">peopleSet</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">new_tracked_person</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="n">userdata</span><span class="o">.</span><span class="n">out_new_tracked_person</span> <span class="o">=</span> <span class="n">new_tracked_person</span>
                    <span class="n">userdata</span><span class="o">.</span><span class="n">currentFilterTries</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">userdata</span><span class="o">.</span><span class="n">currentUsedFilter</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">isOccluded</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">out_new_tracked_person</span><span class="p">,</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_persons_detected</span><span class="o">.</span><span class="n">peopleSet</span><span class="p">)):</span>
                        <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_BLUE</span> <span class="o">+</span> <span class="s">&quot;Movement and process cancelled till person is not occluded&quot;</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="k">return</span> <span class="s">&quot;tracked_person_is_occluded&quot;</span>
                    <span class="k">return</span> <span class="n">succeeded</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">currentFilterTries</span> <span class="o">=</span> <span class="n">tries</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">usedFilter</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">currentUsedFilter</span> <span class="o">=</span> <span class="n">usedFilter</span>

        <span class="c"># FILTER 3 and last filter that will ever execute until success</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">usedFilter</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">debugPrint</span><span class="p">(</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span>
                <span class="s">&#39;    [FAIL]: NO FILTER PASSED: unable to find any plausible candidate. Using last filter till success...&#39;</span> <span class="o">+</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">new_tracked_person</span> <span class="o">=</span> <span class="n">applyFilterFour</span><span class="p">(</span><span class="n">tracked_person</span><span class="p">,</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_persons_detected</span><span class="o">.</span><span class="n">peopleSet</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">new_tracked_person</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">out_new_tracked_person</span> <span class="o">=</span> <span class="n">new_tracked_person</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">currentFilterTries</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">currentUsedFilter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">isOccluded</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">out_new_tracked_person</span><span class="p">,</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_persons_detected</span><span class="o">.</span><span class="n">peopleSet</span><span class="p">)):</span>
                    <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_BLUE</span> <span class="o">+</span> <span class="s">&quot;Movement and process cancelled till person is not occluded&quot;</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s">&quot;tracked_person_is_occluded&quot;</span>
                <span class="k">return</span> <span class="n">succeeded</span>

        <span class="n">debugPrint</span><span class="p">(</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">RED_BOLD</span> <span class="o">+</span>
            <span class="s">&#39;    Last filter tried : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">usedFilter</span><span class="p">)</span> <span class="o">+</span>
            <span class="s">&#39;    Filter tries      : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tries</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;no_plausible_person_found&#39;</span>


<span class="k">class</span> <span class="nc">SetNewLocation</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distanceToHuman</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in_new_tracked_person&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;out_new_navgoal&#39;</span><span class="p">])</span>
        <span class="c"># TODO super weird code snippet</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_distanceToHuman</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s">&quot;/params_learn_and_follow_operator_test/distance_to_human&quot;</span><span class="p">,</span> <span class="n">distanceToHuman</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">debugPrint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s">&quot;There was an error while trying to get the parameter. Trying again...&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;### ENTERING &quot;SET_NEW_LOCATION&quot; STATE ###&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c"># getting the distance to human from the parameters file that may have changed by a listened command</span>
        <span class="c"># TODO super weird code snippet</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_distanceToHuman</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s">&quot;/params_learn_and_follow_operator_test/distance_to_human&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">debugPrint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;There was an error while trying to get the parameter. Trying again...&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c">#Calculating vectors for the position indicated</span>
        <span class="n">new_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>
        <span class="n">new_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_new_tracked_person</span><span class="o">.</span><span class="n">x</span>
        <span class="n">new_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_new_tracked_person</span><span class="o">.</span><span class="n">y</span>
        <span class="n">unit_vector</span> <span class="o">=</span> <span class="n">normalize_vector</span><span class="p">(</span><span class="n">new_pose</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="n">position_distance</span> <span class="o">=</span> <span class="n">vector_magnitude</span><span class="p">(</span><span class="n">new_pose</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;    Position data from Reem to person:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;        Position vector          : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_pose</span><span class="o">.</span><span class="n">position</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;        Unit position vector     : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">unit_vector</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;        Position vector distance : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position_distance</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;        Distance to human        : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distanceToHuman</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If person is closer than the distance given, we wont move but we might rotate.</span>
<span class="sd">        We want that if the person comes closer, the robot stays in the place.</span>
<span class="sd">        Thats why we make desired distance zero if person too close.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">#atan2 will return a value inside (-Pi, +Pi) so we can compute the correct quadrant</span>
        <span class="n">alfa</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">new_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">new_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">distance_des</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">position_distance</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distanceToHuman</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">:</span>  <span class="c"># offset of 0.25 so the robot moves at least 0.25m</span>
            <span class="n">distance_des</span> <span class="o">=</span> <span class="n">position_distance</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distanceToHuman</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;    Person too close =&gt; not moving, just rotate&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">dist_vector</span> <span class="o">=</span> <span class="n">multiply_vector</span><span class="p">(</span><span class="n">unit_vector</span><span class="p">,</span> <span class="n">distance_des</span><span class="p">)</span>

        <span class="n">alfa_degree</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span>

        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;    Final robot movement data:&#39;</span><span class="p">)</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;        Distance from robot center to person                 : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position_distance</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;        Person and Reem wanted distance (distance to human)  : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distanceToHuman</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;        Distance that REEM will move towards the person      : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">distance_des</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;        Degrees that REEM will rotate                        : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alfa_degree</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">nav_goal</span> <span class="o">=</span> <span class="n">PoseStamped</span><span class="p">()</span>
        <span class="n">nav_goal</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">nav_goal</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">&quot;/base_link&quot;</span>
        <span class="n">nav_goal</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">dist_vector</span>
        <span class="n">nav_goal</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="p">(</span><span class="o">*</span><span class="n">quaternion_from_euler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alfa</span><span class="p">))</span>
        <span class="n">userdata</span><span class="o">.</span><span class="n">out_new_navgoal</span> <span class="o">=</span> <span class="n">nav_goal</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;    This is the Nav Goal We send to REEM: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nav_goal</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">succeeded</span>


<span class="k">class</span> <span class="nc">UserdataClassForPublishGeneralMarker</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setVar</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setVar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>


<div class="viewcode-block" id="PublishGoToLocationMarkers"><a class="viewcode-back" href="../pkg_documentation/pal_smach_utils/pal_smach_utils_doc.html#track_operator.PublishGoToLocationMarkers">[docs]</a><span class="k">def</span> <span class="nf">PublishGoToLocationMarkers</span><span class="p">(</span><span class="n">pose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The input is a Pose(). Publishes a blue sphere in the position of the goal.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">class_pose</span> <span class="o">=</span> <span class="n">UserdataClassForPublishGeneralMarker</span><span class="p">()</span>
    <span class="n">class_pose</span><span class="o">.</span><span class="n">in_pose</span> <span class="o">=</span> <span class="n">pose</span>
    <span class="n">marker_state</span> <span class="o">=</span> <span class="n">PublishGeneralMarker</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">GO_LOC_MARKER_SCALE</span><span class="p">,</span> <span class="n">marker_name</span><span class="o">=</span><span class="n">GO_LOC_MARKER_NAME</span><span class="p">,</span> <span class="n">marker_type</span><span class="o">=</span><span class="n">GO_LOC_MARKER_TYPE</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">GO_LOC_MARKER_COLOUR</span><span class="p">)</span>
    <span class="n">marker_state</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">class_pose</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span>

</div>
<span class="k">class</span> <span class="nc">GoToLocation</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="n">succeeded</span><span class="p">,</span> <span class="n">preempted</span><span class="p">,</span> <span class="n">aborted</span><span class="p">],</span> <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in_new_navgoal&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="n">MOVE_BASE_TOPIC_GOAL</span><span class="p">,</span> <span class="n">PoseStamped</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;### ENTERING &quot;GO_TO_LOCATION&quot; STATE ###&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">PublishGoToLocationMarkers</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_new_navgoal</span><span class="o">.</span><span class="n">pose</span><span class="p">)</span>

        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&#39;    Data that will be sent to the topic &#39;</span> <span class="o">+</span> <span class="n">MOVE_BASE_TOPIC_GOAL</span> <span class="o">+</span> <span class="s">&#39; the pose:</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_new_navgoal</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="n">MOVE_BASE_TOPIC_GOAL</span><span class="p">,</span> <span class="n">PoseStamped</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_new_navgoal</span><span class="p">)</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">GO_TO_LOC_TIMEOUT</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">succeeded</span>


<span class="k">class</span> <span class="nc">TrackOperator</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distToHuman</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="p">[</span><span class="n">succeeded</span><span class="p">,</span> <span class="n">preempted</span><span class="p">,</span> <span class="n">aborted</span><span class="p">],</span>
                                    <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in_personTrackingData&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">initTrackOperatorVariables</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">out_new_tracked_person</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_personTrackingData</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">currentFilterTries</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">currentUsedFilter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">global</span> <span class="n">last_time_occluded</span>
                <span class="n">last_time_occluded</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">global</span> <span class="n">not_say_again</span>
                <span class="n">not_say_again</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;INIT_TRACK_OPERATOR_VARIABLES&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">initTrackOperatorVariables</span><span class="p">,</span>
                                           <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in_personTrackingData&#39;</span><span class="p">],</span>
                                           <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;out_new_tracked_person&quot;</span><span class="p">,</span> <span class="s">&quot;currentFilterTries&quot;</span><span class="p">,</span> <span class="s">&quot;currentUsedFilter&quot;</span><span class="p">]),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;GRAB_PEOPLE_TRACKER_DATA&#39;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;in_personTrackingData&quot;</span><span class="p">:</span> <span class="s">&quot;in_personTrackingData&quot;</span><span class="p">,</span>
                                              <span class="s">&quot;out_new_tracked_person&quot;</span><span class="p">:</span> <span class="s">&quot;out_new_tracked_person&quot;</span><span class="p">,</span>
                                              <span class="s">&quot;currentFilterTries&quot;</span><span class="p">:</span> <span class="s">&quot;currentFilterTries&quot;</span><span class="p">,</span>
                                              <span class="s">&quot;currentUsedFilter&quot;</span><span class="p">:</span> <span class="s">&quot;currentUsedFilter&quot;</span><span class="p">})</span>

            <span class="c"># When timeout is set to None, TopicReaderState will wait till it reads some data</span>
            <span class="c"># We rely in the people tracker in this case because this state will always finish</span>
            <span class="c"># since the people tracker will send at least an empty array of persons detected</span>
            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;GRAB_PEOPLE_TRACKER_DATA&#39;</span><span class="p">,</span>
                                   <span class="n">TopicReaderState</span><span class="p">(</span><span class="n">topic_name</span><span class="o">=</span><span class="s">&#39;/iri_people_tracking_rai/peopleSet&#39;</span><span class="p">,</span> <span class="n">msg_type</span><span class="o">=</span><span class="n">peopleTrackingArray</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;FILTER_AND_PROCESS_PEOPLE_TRACKER_DATA&#39;</span><span class="p">,</span>
                                                <span class="n">preempted</span><span class="p">:</span> <span class="n">preempted</span><span class="p">,</span>
                                                <span class="n">aborted</span><span class="p">:</span> <span class="s">&#39;GRAB_PEOPLE_TRACKER_DATA&#39;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;out_persons_detected&#39;</span><span class="p">})</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;FILTER_AND_PROCESS_PEOPLE_TRACKER_DATA&#39;</span><span class="p">,</span>
                                   <span class="n">FilterAndProcessPeopleTrackerData</span><span class="p">(),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&quot;RESET_OCCLUDED_TIME&quot;</span><span class="p">,</span>
                                                <span class="s">&#39;no_plausible_person_found&#39;</span><span class="p">:</span> <span class="s">&#39;GRAB_PEOPLE_TRACKER_DATA&#39;</span><span class="p">,</span>
                                                <span class="s">&#39;tracked_person_is_occluded&#39;</span><span class="p">:</span> <span class="s">&#39;CHANGE_PERSON_DATA_TO_NOT_FOLLOW&#39;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;in_persons_detected&#39;</span><span class="p">:</span> <span class="s">&#39;out_persons_detected&#39;</span><span class="p">,</span>
                                              <span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">:</span> <span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">,</span>
                                              <span class="s">&quot;currentFilterTries&quot;</span><span class="p">:</span> <span class="s">&quot;currentFilterTries&quot;</span><span class="p">,</span>
                                              <span class="s">&quot;currentUsedFilter&quot;</span><span class="p">:</span> <span class="s">&quot;currentUsedFilter&quot;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">resetOccludedTime</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="k">global</span> <span class="n">last_time_occluded</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">last_time_occluded</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="n">last_time_occluded</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">last_time_occluded</span> <span class="o">=</span> <span class="n">last_time_occluded</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;RESET_OCCLUDED_TIME&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">resetOccludedTime</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;PUBLISH_TARGET_ID&#39;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">,</span> <span class="s">&quot;reduced_distance&quot;</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">changePersonDataToNotFollow</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="n">modified_person</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">out_new_tracked_person</span>

                <span class="n">alfa</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">modified_person</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">modified_person</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span>

                <span class="n">dist</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">modified_person</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">dist</span>
                <span class="n">modified_person</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">dist</span>

                <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;New data of the person(alfa = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;):</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">modified_person</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

                <span class="n">userdata</span><span class="o">.</span><span class="n">out_new_tracked_person</span> <span class="o">=</span> <span class="n">modified_person</span>

                <span class="c">#FIXME</span>
                <span class="k">global</span> <span class="n">last_time_occluded</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">last_time_occluded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="k">global</span> <span class="n">not_say_again</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">not_say_again</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">succeeded</span>
                    <span class="n">current_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">current_time</span> <span class="o">=</span> <span class="n">current_time</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span>

                    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_time_occluded</span>
                    <span class="n">debugPrint</span><span class="p">(</span>
                        <span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_YELLOW</span> <span class="o">+</span>
                        <span class="s">&quot;Elapsed time since last occlusion: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span> <span class="o">+</span>
                        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">elapsed_time</span> <span class="o">&gt;</span> <span class="n">SECONDS_TO_BE_CONSIDERED_OCCLUDED</span><span class="p">):</span>
                        <span class="c">#we try to set the parameter till it doesn&#39;t throw any error</span>
                        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c">#FIXME ROBOCUP HACK</span>
                                <span class="c">#rospy.set_param(&quot;/params_learn_and_follow_operator_test/distance_to_human&quot;, ELEVATOR_DISTANCE_TO_HUMAN)</span>
                                <span class="k">break</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                <span class="n">debugPrint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;There was an error while trying to set the parameter. Trying again...&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">not_say_again</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">return</span> <span class="s">&quot;reduced_distance&quot;</span>

                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;CHANGE_PERSON_DATA_TO_NOT_FOLLOW&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">changePersonDataToNotFollow</span><span class="p">,</span> <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">],</span> <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">]),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;PUBLISH_TARGET_ID&#39;</span><span class="p">,</span>
                                                <span class="s">&quot;reduced_distance&quot;</span><span class="p">:</span> <span class="s">&quot;PUBLISH_TARGET_ID&quot;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">:</span> <span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">})</span>

            <span class="n">reduced_distance_text</span> <span class="o">=</span> <span class="s">&quot;I have reduced the distance.&quot;</span>
            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SAY_REDUCED_DISTANCE&#39;</span><span class="p">,</span>
                                   <span class="n">SpeakActionState</span><span class="p">(</span><span class="n">reduced_distance_text</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;PUBLISH_TARGET_ID&#39;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">publishFollowMeTargetId</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="n">printPersonStatus</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_new_tracked_person</span><span class="p">)</span>
                <span class="c">#pub = rospy.Publisher(&quot;followMe/targetId&quot;, Int32)</span>
                <span class="c">#pub.publish(userdata.in_new_tracked_person.targetId)</span>
                <span class="n">debugPrint</span><span class="p">(</span>
                    <span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_GREEN</span> <span class="o">+</span>
                    <span class="s">&#39;    Following the target Id =&gt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_new_tracked_person</span><span class="o">.</span><span class="n">targetId</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s">&#39;    Status of the target    =&gt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_new_tracked_person</span><span class="o">.</span><span class="n">targetStatus</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;PUBLISH_TARGET_ID&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">publishFollowMeTargetId</span><span class="p">,</span> <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in_new_tracked_person&#39;</span><span class="p">]),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;DETECT_ELEVATOR&#39;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;in_new_tracked_person&#39;</span><span class="p">:</span> <span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">detectElevator</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>

                <span class="c">#FIXME will not go inside the if ever, was just an idea for robocup</span>
                <span class="n">person_inside_elevator</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">person_inside_elevator</span><span class="p">):</span>
                    <span class="n">debugPrint</span><span class="p">(</span>
                        <span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_YELLOW</span> <span class="o">+</span>
                        <span class="s">&quot;Person inside elevator! Reducing following distance...&quot;</span> <span class="o">+</span>
                        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="c">#we try to set the parameter till it doesn&#39;t throw any error</span>
                    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s">&quot;/params_learn_and_follow_operator_test/distance_to_human&quot;</span><span class="p">,</span> <span class="n">ELEVATOR_DISTANCE_TO_HUMAN</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                            <span class="n">debugPrint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;There was an error while trying to set the parameter. Trying again...&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">debugPrint</span><span class="p">(</span>
                        <span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_YELLOW</span> <span class="o">+</span>
                        <span class="s">&quot;The following distance was reduced to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ELEVATOR_DISTANCE_TO_HUMAN</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; meters&quot;</span> <span class="o">+</span>
                        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;DETECT_ELEVATOR&quot;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">detectElevator</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&quot;SET_NEW_LOCATION&quot;</span><span class="p">})</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SET_NEW_LOCATION&#39;</span><span class="p">,</span>
                                   <span class="n">SetNewLocation</span><span class="p">(</span><span class="n">distToHuman</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;GO_TO_LOCATION&#39;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;in_new_tracked_person&#39;</span><span class="p">:</span> <span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">,</span>
                                              <span class="s">&#39;out_new_navgoal&#39;</span><span class="p">:</span> <span class="s">&#39;out_new_navgoal&#39;</span><span class="p">})</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;GO_TO_LOCATION&#39;</span><span class="p">,</span>
                                   <span class="n">GoToLocation</span><span class="p">(),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;LOOK_AT_PERSON&#39;</span><span class="p">,</span> <span class="n">preempted</span><span class="p">:</span> <span class="s">&quot;LOOK_AT_PERSON&quot;</span><span class="p">,</span> <span class="n">aborted</span><span class="p">:</span> <span class="s">&quot;LOOK_AT_PERSON&quot;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;in_new_navgoal&#39;</span><span class="p">:</span> <span class="s">&#39;out_new_navgoal&#39;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">,</span> <span class="n">preempted</span><span class="p">,</span> <span class="n">aborted</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">lookAtLocation</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="c">#FIXME</span>
                <span class="n">head_goal</span> <span class="o">=</span> <span class="n">PointHeadGoal</span><span class="p">()</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">&quot;base_link&quot;</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_new_tracked_person</span><span class="o">.</span><span class="n">x</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_new_tracked_person</span><span class="o">.</span><span class="n">y</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">person_height</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_frame</span> <span class="o">=</span> <span class="s">&quot;stereo_link&quot;</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_axis</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_axis</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_axis</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">max_velocity</span> <span class="o">=</span> <span class="mf">1.5</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">min_duration</span><span class="o">.</span><span class="n">secs</span> <span class="o">=</span> <span class="mf">1.5</span>

                <span class="n">head_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>

                <span class="n">head_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">head_goal</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;LOOK_AT_PERSON&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">lookAtLocation</span><span class="p">,</span> <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;in_new_tracked_person&quot;</span><span class="p">]),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&quot;GRAB_PEOPLE_TRACKER_DATA&quot;</span><span class="p">,</span>
                                                <span class="n">preempted</span><span class="p">:</span> <span class="s">&quot;GRAB_PEOPLE_TRACKER_DATA&quot;</span><span class="p">,</span>
                                                <span class="n">aborted</span><span class="p">:</span> <span class="s">&quot;GRAB_PEOPLE_TRACKER_DATA&quot;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;in_new_tracked_person&#39;</span><span class="p">:</span> <span class="s">&#39;out_new_tracked_person&#39;</span><span class="p">})</span>


<span class="sd">&#39;&#39;&#39;&#39;&#39;&#39;</span><span class="s">&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;</span>


<span class="k">class</span> <span class="nc">LearnPerson</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distToHuman</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="p">[</span><span class="n">succeeded</span><span class="p">,</span> <span class="n">preempted</span><span class="p">,</span> <span class="n">aborted</span><span class="p">],</span>
                                    <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;out_personTrackingData&#39;</span><span class="p">],</span>
                                    <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;in_learn_person&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;learn&quot;</span><span class="p">,</span> <span class="s">&quot;not_learn&quot;</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">learnOrNot</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_learn_person</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s">&quot;learn&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;not_learn&quot;</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;LEARN_OR_NOT&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">learnOrNot</span><span class="p">,</span> <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in_learn_person&#39;</span><span class="p">]),</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;in_learn_person&#39;</span><span class="p">:</span> <span class="s">&quot;in_learn_person&quot;</span><span class="p">},</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;learn&quot;</span><span class="p">:</span> <span class="s">&#39;SAY_STAY_STILL&#39;</span><span class="p">,</span>
                                                <span class="s">&quot;not_learn&quot;</span><span class="p">:</span> <span class="s">&quot;INIT_MOCK_PERSON&quot;</span><span class="p">})</span>

            <span class="n">intro_text</span> <span class="o">=</span> <span class="s">&quot;Please stay still while I learn how you look like.&quot;</span>
            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SAY_STAY_STILL&#39;</span><span class="p">,</span>
                                   <span class="n">SpeakActionState</span><span class="p">(</span><span class="n">intro_text</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;CREATE_LEARNING_ZONE_MARKER&#39;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">createLearningZoneMarker</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="k">global</span> <span class="n">pt_learning_zone_marker_pub</span>
                <span class="k">global</span> <span class="n">learning_zone_marker</span>
                <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;Creating learning zone marker...&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">pt_learning_zone_marker_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s">&quot;/LEARNING_ZONE_people_tracker_test/&quot;</span><span class="p">,</span> <span class="n">Marker</span><span class="p">)</span>

                <span class="n">learning_zone_marker</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">()</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">&quot;/base_link&quot;</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="s">&quot;learning_zone_ns&quot;</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">LINE_STRIP</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">ADD</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(),</span> <span class="n">Point</span><span class="p">(),</span> <span class="n">Point</span><span class="p">(),</span> <span class="n">Point</span><span class="p">()]</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">MAX_LEARN_DISTANCE</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">MAX_LEARN_DISPLACEMENT</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">MAX_LEARN_DISTANCE</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">MAX_LEARN_DISPLACEMENT</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="mf">0.3</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">lifetime</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;CREATE_LEARNING_ZONE_MARKER&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">createLearningZoneMarker</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;PUBLISH_LEARNING_ZONE_MARKER&#39;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">publishLearningZoneMarker</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="k">global</span> <span class="n">pt_learning_zone_marker_pub</span>
                <span class="k">global</span> <span class="n">learning_zone_marker</span>
                <span class="n">learning_zone_marker</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

                <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;Publishing learning zone marker...&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">pt_learning_zone_marker_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">learning_zone_marker</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;PUBLISH_LEARNING_ZONE_MARKER&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">publishLearningZoneMarker</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;LEARN_AND_GRAB_PEOPLE_TRACKER_DATA&#39;</span><span class="p">})</span>

            <span class="c"># When timeout is set to None, TopicReaderState will wait till it reads some data</span>
            <span class="c"># We rely in the people tracker in this case because this state will always finish</span>
            <span class="c"># since the people tracker will send at least an empty array of persons detected</span>
            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;LEARN_AND_GRAB_PEOPLE_TRACKER_DATA&#39;</span><span class="p">,</span>
                                   <span class="n">TopicReaderState</span><span class="p">(</span><span class="n">topic_name</span><span class="o">=</span><span class="s">&#39;/iri_people_tracking_rai/peopleSet&#39;</span><span class="p">,</span> <span class="n">msg_type</span><span class="o">=</span><span class="n">peopleTrackingArray</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;LEARN_AND_PROCESS_PEOPLE_TRACKER_DATA&#39;</span><span class="p">,</span>
                                                <span class="n">preempted</span><span class="p">:</span> <span class="n">preempted</span><span class="p">,</span>
                                                <span class="n">aborted</span><span class="p">:</span> <span class="s">&#39;PUBLISH_LEARNING_ZONE_MARKER&#39;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;out_persons_detected&#39;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">,</span> <span class="s">&#39;anyone_in_front&#39;</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">showAndProcessPeopleTrackerData</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s">&quot;Showing people tracker data...&quot;</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">tracked_person</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">min_distance</span> <span class="o">=</span> <span class="n">MAX_LEARN_DISTANCE</span>
                <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">userdata</span><span class="o">.</span><span class="n">in_persons_detected</span><span class="o">.</span><span class="n">peopleSet</span><span class="p">:</span>
                    <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">displace</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                    <span class="n">person_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>
                    <span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">vector_magnitude</span><span class="p">(</span><span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

                    <span class="c">#little hack to use the same variable and function</span>
                    <span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">vx</span>
                    <span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">vy</span>
                    <span class="n">velocity</span> <span class="o">=</span> <span class="n">vector_magnitude</span><span class="p">(</span><span class="n">person_pose</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

                    <span class="n">printPersonStatus</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
                    <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="s">&quot;    displace =&gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">displace</span><span class="p">)</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="s">&quot;    distance =&gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">CYAN</span> <span class="o">+</span> <span class="s">&quot;    velocity =&gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">isVisuallyConfirmed</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="ow">and</span> <span class="n">displace</span> <span class="o">&lt;</span> <span class="n">MAX_LEARN_DISPLACEMENT</span> <span class="ow">and</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">min_distance</span> <span class="ow">and</span> <span class="n">velocity</span> <span class="o">&lt;</span> <span class="n">MAX_STILL_VELOCITY</span><span class="p">:</span>
                        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;CONDITIONS CONDITIONS CONDITIONS&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;visual consition&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">isVisuallyConfirmed</span><span class="p">(</span><span class="n">person</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;displace&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">displace</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;distance&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">distance</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">debugPrint</span><span class="p">(</span><span class="s">&quot;velocity&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">min_distance</span> <span class="o">=</span> <span class="n">distance</span>
                        <span class="n">tracked_person</span> <span class="o">=</span> <span class="n">person</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">tracked_person</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="n">debugPrint</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">YELLOW_BOLD</span> <span class="o">+</span> <span class="s">&quot;    THERE ISN&#39;T ANY STILL CANDIDATE IN FRONT OF THE ROBOT&quot;</span> <span class="o">+</span> <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s">&#39;anyone_in_front&#39;</span>

                <span class="n">userdata</span><span class="o">.</span><span class="n">out_personTrackingData</span> <span class="o">=</span> <span class="n">tracked_person</span>
                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;LEARN_AND_PROCESS_PEOPLE_TRACKER_DATA&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">showAndProcessPeopleTrackerData</span><span class="p">,</span> <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in_persons_detected&#39;</span><span class="p">],</span> <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;out_personTrackingData&#39;</span><span class="p">]),</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;in_persons_detected&#39;</span><span class="p">:</span> <span class="s">&#39;out_persons_detected&#39;</span><span class="p">,</span>
                                              <span class="s">&#39;out_personTrackingData&#39;</span><span class="p">:</span> <span class="s">&#39;out_personTrackingData&#39;</span><span class="p">},</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;SAY_LOOK&#39;</span><span class="p">,</span>
                                                <span class="s">&#39;anyone_in_front&#39;</span><span class="p">:</span> <span class="s">&#39;PUBLISH_LEARNING_ZONE_MARKER&#39;</span><span class="p">})</span>

            <span class="n">look_text</span> <span class="o">=</span> <span class="s">&quot;Please, stay still and stand up straight while looking at my head.&quot;</span>
            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SAY_LOOK&#39;</span><span class="p">,</span>
                                   <span class="n">SpeakActionState</span><span class="p">(</span><span class="n">look_text</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;MOVE_HEAD_NEXT_HEIGHT&#39;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">,</span> <span class="n">aborted</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">moveHeadNextHeight</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>

                <span class="k">global</span> <span class="n">robot_head_heights_index</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">robot_head_heights_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">robot_head_heights</span><span class="p">)):</span>
                    <span class="n">robot_head_heights_index</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">return</span> <span class="n">aborted</span>
                <span class="n">head_z</span> <span class="o">=</span> <span class="n">robot_head_heights</span><span class="p">[</span><span class="n">robot_head_heights_index</span><span class="p">]</span>

                <span class="n">head_goal</span> <span class="o">=</span> <span class="n">PointHeadGoal</span><span class="p">()</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">&quot;base_link&quot;</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">head_z</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_frame</span> <span class="o">=</span> <span class="s">&quot;stereo_link&quot;</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_axis</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_axis</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_axis</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">max_velocity</span> <span class="o">=</span> <span class="mf">1.5</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">min_duration</span><span class="o">.</span><span class="n">secs</span> <span class="o">=</span> <span class="mf">1.5</span>

                <span class="n">head_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>

                <span class="n">head_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">head_goal</span><span class="p">)</span>

                <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>

                <span class="n">robot_head_heights_index</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;MOVE_HEAD_NEXT_HEIGHT&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">moveHeadNextHeight</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&quot;GET_FACES_AND_PERSON_HEIGHT&quot;</span><span class="p">,</span>
                                                <span class="n">aborted</span><span class="p">:</span> <span class="s">&quot;SAY_LOOK&quot;</span><span class="p">})</span>

            <span class="k">def</span> <span class="nf">getFacesAndPersonHeight</span><span class="p">(</span><span class="n">userdata</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
                <span class="n">min_face_base_distance</span> <span class="o">=</span> <span class="n">MAX_LEARN_DISTANCE</span>
                <span class="n">height_of_min_face</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">faces</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">faces</span>

                <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
                    <span class="c"># the message is already in 3D</span>
                    <span class="n">face_base_distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">face</span><span class="o">.</span><span class="n">position3D</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">face</span><span class="o">.</span><span class="n">position3D</span><span class="o">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">face_base_distance</span> <span class="o">&lt;</span> <span class="n">min_face_base_distance</span><span class="p">):</span>
                        <span class="n">min_face_base_distance</span> <span class="o">=</span> <span class="n">face_base_distance</span>
                        <span class="n">height_of_min_face</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">position3D</span><span class="o">.</span><span class="n">z</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">height_of_min_face</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="k">global</span> <span class="n">person_height</span>
                    <span class="n">person_height</span> <span class="o">=</span> <span class="n">height_of_min_face</span>
                    <span class="n">debugPrint</span><span class="p">(</span>
                        <span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_GREEN</span> <span class="o">+</span>
                        <span class="s">&quot;The height of the person being tracked is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">person_height</span><span class="p">)</span> <span class="o">+</span>
                        <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">succeeded</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">aborted</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s">&#39;GET_FACES_AND_PERSON_HEIGHT&#39;</span><span class="p">,</span>
                <span class="n">TopicReaderState</span><span class="p">(</span>
                    <span class="n">topic_name</span><span class="o">=</span><span class="s">&#39;/person/faceDetections&#39;</span><span class="p">,</span>
                    <span class="n">msg_type</span><span class="o">=</span><span class="n">FaceDetections</span><span class="p">,</span>
                    <span class="n">callback</span><span class="o">=</span><span class="n">getFacesAndPersonHeight</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">DETECT_FACE_TIMEOUT</span><span class="p">),</span>
                <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;FIX_HEAD&#39;</span><span class="p">,</span>
                             <span class="n">aborted</span><span class="p">:</span> <span class="s">&quot;MOVE_HEAD_NEXT_HEIGHT&quot;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">,</span> <span class="n">preempted</span><span class="p">,</span> <span class="n">aborted</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">fixHeadPosition</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="n">head_goal</span> <span class="o">=</span> <span class="n">PointHeadGoal</span><span class="p">()</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">&quot;base_link&quot;</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">person_height</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_frame</span> <span class="o">=</span> <span class="s">&quot;stereo_link&quot;</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_axis</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_axis</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">pointing_axis</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">max_velocity</span> <span class="o">=</span> <span class="mf">1.5</span>
                <span class="n">head_goal</span><span class="o">.</span><span class="n">min_duration</span><span class="o">.</span><span class="n">secs</span> <span class="o">=</span> <span class="mf">1.5</span>

                <span class="n">head_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">5.0</span><span class="p">))</span>

                <span class="n">head_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">head_goal</span><span class="p">)</span>

                <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;FIX_HEAD&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">fixHeadPosition</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&quot;SAY_TURN_AROUND&quot;</span><span class="p">,</span>
                                                <span class="n">preempted</span><span class="p">:</span> <span class="s">&quot;SAY_TURN_AROUND&quot;</span><span class="p">,</span>
                                                <span class="n">aborted</span><span class="p">:</span> <span class="s">&quot;SAY_TURN_AROUND&quot;</span><span class="p">})</span>

            <span class="n">turn_around_text</span> <span class="o">=</span> <span class="s">&quot;Ok! I have seen your face. Now please, turn around.&quot;</span>
            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SAY_TURN_AROUND&#39;</span><span class="p">,</span>
                                   <span class="n">SpeakActionState</span><span class="p">(</span><span class="n">turn_around_text</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;SLEEP_TILL_PERSON_TURNS&#39;</span><span class="p">})</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SLEEP_TILL_PERSON_TURNS&#39;</span><span class="p">,</span>
                                   <span class="n">SleepState</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;PUBLISH_TARGET_ID&#39;</span><span class="p">,</span>
                                                <span class="n">preempted</span><span class="p">:</span> <span class="s">&#39;PUBLISH_TARGET_ID&#39;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">publishFollowMeTargetId</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="c">#pub = rospy.Publisher(&quot;followMe/targetId&quot;, Int32)</span>
                <span class="c">#pub.publish(userdata.in_personTrackingData.targetId)</span>
                <span class="n">debugPrint</span><span class="p">(</span>
                    <span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_GREEN</span> <span class="o">+</span>
                    <span class="s">&#39;    Following the target Id =&gt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_personTrackingData</span><span class="o">.</span><span class="n">targetId</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s">&#39;    Status of the target    =&gt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_personTrackingData</span><span class="o">.</span><span class="n">targetStatus</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;PUBLISH_TARGET_ID&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">publishFollowMeTargetId</span><span class="p">,</span> <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in_personTrackingData&#39;</span><span class="p">]),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;SLEEP_TILL_READY_TO_FOLLOW&#39;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;in_personTrackingData&#39;</span><span class="p">:</span> <span class="s">&#39;out_personTrackingData&#39;</span><span class="p">})</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SLEEP_TILL_READY_TO_FOLLOW&#39;</span><span class="p">,</span>
                                   <span class="n">SleepState</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;SAY_READY_TO_FOLLOW&#39;</span><span class="p">,</span>
                                                <span class="n">preempted</span><span class="p">:</span> <span class="s">&#39;SAY_READY_TO_FOLLOW&#39;</span><span class="p">})</span>

            <span class="n">ready_text</span> <span class="o">=</span> <span class="s">&quot;I&#39;m ready to follow you.&quot;</span>
            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SAY_READY_TO_FOLLOW&#39;</span><span class="p">,</span>
                                   <span class="n">SpeakActionState</span><span class="p">(</span><span class="n">ready_text</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="n">succeeded</span><span class="p">})</span>

            <span class="sd">&#39;&#39;&#39;&#39;&#39;&#39;</span><span class="s">&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;</span>

            <span class="sd">&#39;&#39;&#39;smach.StateMachine.add(&quot;DETECT_PERSON_WAVING&quot;,</span>
<span class="sd">                                   GestureRecognition(),</span>
<span class="sd">                                   transitions={succeeded: &quot;SAY_CAN_SEE_YOU_WAVING&quot;,</span>
<span class="sd">                                                preempted: &quot;SAY_CANNOT_SEE_YOU_WAVING&quot;,</span>
<span class="sd">                                                aborted: &quot;SAY_CANNOT_SEE_YOU_WAVING&quot;},</span>
<span class="sd">                                   remapping={&quot;out_waving_person_position&quot;: &quot;out_person_position&quot;})&#39;&#39;&#39;</span>

            <span class="n">not_waving_text</span> <span class="o">=</span> <span class="s">&quot;Sorry, i can&#39;t see you. Could you wave?&quot;</span>
            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SAY_CANNOT_SEE_YOU_WAVING&#39;</span><span class="p">,</span>
                                   <span class="n">SpeakActionState</span><span class="p">(</span><span class="n">not_waving_text</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&quot;DETECT_PERSON_WAVING&quot;</span><span class="p">})</span>

            <span class="n">waving_text</span> <span class="o">=</span> <span class="s">&quot;I can see you. Please, wait me!&quot;</span>
            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SAY_CAN_SEE_YOU_WAVING&#39;</span><span class="p">,</span>
                                   <span class="n">SpeakActionState</span><span class="p">(</span><span class="n">waving_text</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&quot;INIT_WAVE_PERSON&quot;</span><span class="p">})</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;DETECT_PERSON_WAVING&quot;</span><span class="p">,</span>
                                   <span class="n">MoveToCallerStateMachine</span><span class="p">(),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&quot;SAY_CAN_SEE_YOU_WAVING&quot;</span><span class="p">,</span>
                                                <span class="n">preempted</span><span class="p">:</span> <span class="s">&quot;SAY_CANNOT_SEE_YOU_WAVING&quot;</span><span class="p">,</span>
                                                <span class="n">aborted</span><span class="p">:</span> <span class="s">&quot;SAY_CANNOT_SEE_YOU_WAVING&quot;</span><span class="p">},</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;out_waving_person_position&quot;</span><span class="p">:</span> <span class="s">&quot;out_caller_position&quot;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">initWavePerson</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="n">debugPrint</span><span class="p">(</span>
                    <span class="n">colors</span><span class="o">.</span><span class="n">BACKGROUND_BLUE</span> <span class="o">+</span>
                    <span class="s">&quot;Position of the waving person&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_waving_person_position</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">colors</span><span class="o">.</span><span class="n">NATIVE_COLOR</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">person</span> <span class="o">=</span> <span class="n">peopleTracking</span><span class="p">()</span>
                <span class="n">person</span><span class="o">.</span><span class="n">targetId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">person</span><span class="o">.</span><span class="n">targetStatus</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">waving_pose</span> <span class="o">=</span> <span class="n">transform_pose</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">in_waving_person_position</span><span class="o">.</span><span class="n">pose</span><span class="p">,</span> <span class="s">&quot;/map&quot;</span><span class="p">,</span> <span class="s">&quot;/base_link&quot;</span><span class="p">)</span>
                <span class="n">person</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">waving_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
                <span class="n">person</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">waving_pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
                <span class="n">person</span><span class="o">.</span><span class="n">vx</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">person</span><span class="o">.</span><span class="n">vy</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">out_personTrackingData</span> <span class="o">=</span> <span class="n">person</span>
                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;INIT_WAVE_PERSON&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">initWavePerson</span><span class="p">,</span> <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;in_waving_person_position&quot;</span><span class="p">],</span> <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;out_personTrackingData&#39;</span><span class="p">]),</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;in_waving_person_position&quot;</span><span class="p">:</span> <span class="s">&quot;out_waving_person_position&quot;</span><span class="p">,</span>
                                              <span class="s">&#39;out_personTrackingData&#39;</span><span class="p">:</span> <span class="s">&#39;out_personTrackingData&#39;</span><span class="p">},</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;SAY_READY_TO_FOLLOW_AGAIN&#39;</span><span class="p">})</span>

            <span class="nd">@smach.cb_interface</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="n">succeeded</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">initMockPerson</span><span class="p">(</span><span class="n">userdata</span><span class="p">):</span>
                <span class="n">person</span> <span class="o">=</span> <span class="n">peopleTracking</span><span class="p">()</span>
                <span class="n">person</span><span class="o">.</span><span class="n">targetId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">person</span><span class="o">.</span><span class="n">targetStatus</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">person</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">person</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">person</span><span class="o">.</span><span class="n">vx</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">person</span><span class="o">.</span><span class="n">vy</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">userdata</span><span class="o">.</span><span class="n">out_personTrackingData</span> <span class="o">=</span> <span class="n">person</span>
                <span class="k">return</span> <span class="n">succeeded</span>

            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;INIT_MOCK_PERSON&#39;</span><span class="p">,</span>
                                   <span class="n">CBState</span><span class="p">(</span><span class="n">initMockPerson</span><span class="p">,</span> <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;out_personTrackingData&#39;</span><span class="p">]),</span>
                                   <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;out_personTrackingData&#39;</span><span class="p">:</span> <span class="s">&#39;out_personTrackingData&#39;</span><span class="p">},</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="s">&#39;SAY_READY_TO_FOLLOW_AGAIN&#39;</span><span class="p">})</span>

            <span class="n">ready_text</span> <span class="o">=</span> <span class="s">&quot;Ok! I am following you again.&quot;</span>
            <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;SAY_READY_TO_FOLLOW_AGAIN&#39;</span><span class="p">,</span>
                                   <span class="n">SpeakActionState</span><span class="p">(</span><span class="n">ready_text</span><span class="p">),</span>
                                   <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="n">succeeded</span><span class="p">:</span> <span class="n">succeeded</span><span class="p">})</span>
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../documentation_tutorial/documentation_tutorial.html">DOCUMENTATION TUTORIAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pkg_documentation/pkg_doc.html">Packages Documentation</a></li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="../search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../genindex.html" title="General Index"
             >index</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; Copyright 2013, Reem_Robocup@HOME_Team.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>